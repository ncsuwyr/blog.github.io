<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Fast Large Matrices Multiplication in R Using Rcpp | Yiran's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Fast Large Matrices Multiplication in R Using Rcpp</h1><a id="logo" href="/.">Yiran's Blog</a><p class="description">Ph.D. Student in STAT @NCSU | Data Science Learner</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Fast Large Matrices Multiplication in R Using Rcpp</h1><div class="post-meta">May 8, 2019<span> | </span><span class="category"><a href="/categories/R/">R</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" data-disqus-identifier="2019/05/08/article1/" href="/2019/05/08/article1/#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Rcpp"><span class="toc-number">1.</span> <span class="toc-text">What is Rcpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Preparation"><span class="toc-number">2.</span> <span class="toc-text">Preparation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Install-C-compiler"><span class="toc-number">2.1.</span> <span class="toc-text">Install C++ compiler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Install-Rcpp"><span class="toc-number">2.2.</span> <span class="toc-text">Install Rcpp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">3.</span> <span class="toc-text">Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Step1-Write-the-C-file"><span class="toc-number">3.1.</span> <span class="toc-text">Step1: Write the C++ file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step2-Call-cpp-files-in-R"><span class="toc-number">3.2.</span> <span class="toc-text">Step2: Call .cpp files in R</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Efficiency-Comparison"><span class="toc-number">4.</span> <span class="toc-text">Efficiency Comparison</span></a></li></ol></div></div><div class="post-content"><p>Suppose A and B are two well-defined matrices, we can use <code>A%*%B</code> to realize the multiplication in R. However, if the matrix dimension is getting large, it will be painful to use such a naive operation, taking countless time. In this article, I would like to share a useful method using <strong>Rcpp</strong> which dramatically increases the efficiency. </p>
<h2 id="What-is-Rcpp"><a href="#What-is-Rcpp" class="headerlink" title="What is Rcpp"></a>What is Rcpp</h2><p>R is one of the best languages for statistician since it is simple to use various established packages and to make pretty output, but R is not the fastest or most memory efficient language in general. By contrast, C++/C is faster, but not so easy to use. Is there a way to combine these two languages? Yes! — Rcpp is a R package which enables you to implement C++/C functions in R.  </p>
<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><p>To begin with, we need to do several installations. </p>
<h3 id="Install-C-compiler"><a href="#Install-C-compiler" class="headerlink" title="Install C++ compiler"></a>Install C++ compiler</h3><ul>
<li>For Mac user, you need to install Xcode and <a href="https://cran.r-project.org/bin/macosx/tools/" target="_blank" rel="noopener">development tools</a>. You can execute the command <code>xcode-select --install</code> on Terminal to install Xcode or go to this <a href="%20https://developer.apple.com/xcode/downloads/%20">link</a>.</li>
<li>For Windows user, you need to install <a href="https://cran.r-project.org/bin/windows/Rtools/index.html" target="_blank" rel="noopener">Rtools</a>.</li>
</ul>
<h3 id="Install-Rcpp"><a href="#Install-Rcpp" class="headerlink" title="Install Rcpp"></a>Install Rcpp</h3><p>Execute <code>install.packages(&quot;Rcpp&quot;)</code> in R.</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><h3 id="Step1-Write-the-C-file"><a href="#Step1-Write-the-C-file" class="headerlink" title="Step1: Write the C++ file"></a>Step1: Write the C++ file</h3><p>The below code defines three functions that calculates the multiplication of two matrices. Save this content as a file named “MatrixMtp.cpp”.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [[Rcpp::depends(RcppArmadillo, RcppEigen)]]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;RcppArmadillo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;RcppEigen.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [[Rcpp::export]]</span></span><br><span class="line"><span class="function">SEXP <span class="title">armaMatMult</span><span class="params">(arma::mat A, arma::mat B)</span></span>&#123;</span><br><span class="line">    arma::mat C = A * B;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Rcpp::wrap(C);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [[Rcpp::export]]</span></span><br><span class="line"><span class="function">SEXP <span class="title">eigenMatMult</span><span class="params">(Eigen::MatrixXd A, Eigen::MatrixXd B)</span></span>&#123;</span><br><span class="line">    Eigen::MatrixXd C = A * B;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Rcpp::wrap(C);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [[Rcpp::export]]</span></span><br><span class="line"><span class="function">SEXP <span class="title">eigenMapMatMult</span><span class="params">(<span class="keyword">const</span> Eigen::Map&lt;Eigen::MatrixXd&gt; A, Eigen::Map&lt;Eigen::MatrixXd&gt; B)</span></span>&#123;</span><br><span class="line">    Eigen::MatrixXd C = A * B;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Rcpp::wrap(C);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Step2-Call-cpp-files-in-R"><a href="#Step2-Call-cpp-files-in-R" class="headerlink" title="Step2: Call .cpp files in R"></a>Step2: Call .cpp files in R</h3><p>Then in R, execute the following code:<br><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">library</span>(Rcpp) </span><br><span class="line"></span><br><span class="line">sourceCpp(<span class="string">"./MatrixMtp.cpp"</span>) <span class="comment"># call the C++ file and we have three functions as armaMatMult，eigenMatMult，eigenMapMatMult.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># define two matrices as an example</span></span><br><span class="line">A &lt;- matrix(rnorm(<span class="number">10000</span>), nrow=<span class="number">100</span>, ncol=<span class="number">100</span>)</span><br><span class="line">B &lt;- matrix(rnorm(<span class="number">10000</span>), nrow=<span class="number">100</span>, ncol=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can get the multiplication of A and B by using the following three functions:</span></span><br><span class="line">armaMatMult(A, B)</span><br><span class="line">eigenMatMult(A, B)</span><br><span class="line">eigenMapMatMult(A, B)</span><br></pre></td></tr></table></figure></p>
<h2 id="Efficiency-Comparison"><a href="#Efficiency-Comparison" class="headerlink" title="Efficiency Comparison"></a>Efficiency Comparison</h2><p>Then we compare the three functions as well as the naive R operation.<br><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install "microbenchmark" package for the comparison</span></span><br><span class="line">install.packages(<span class="string">"microbenchmark"</span>)</span><br><span class="line"><span class="keyword">library</span>(microbenchmark)</span><br><span class="line"></span><br><span class="line">print(microbenchmark(A %*% B, armaMatMult(A, B), eigenMatMult(A, B), eigenMapMatMult(A, B),time=<span class="number">5000</span>)<span class="comment"># compare the time by executing each function 5,000 times</span></span><br></pre></td></tr></table></figure></p>
<p>The output is<br><img src="/2019/05/08/article1/cmp1.jpg" alt="Comparison of Four Methods"></p>
<p>We can see the <code>eigenMapMatMult(A, B)</code> function is the fastest one, almost 4 times more efficient than <code>A%*%B</code>.</p>
<p>How does the running time change as the dimension going large? Will the advantage remain?<br><img src="/2019/05/08/article1/cmp2.png" alt="Running Time with 100 Replications"></p>
<p>It is shown that the advantage of <code>eigenMapMatMult(A, B)</code>  and <code>eigenMatMult(A, B)</code> is getting larger as the sample size increasing.</p>
<p>References:</p>
<ol>
<li><a href="https://stackoverflow.com/questions/35923787/fast-large-matrix-multiplication-in-r" target="_blank" rel="noopener">https://stackoverflow.com/questions/35923787/fast-large-matrix-multiplication-in-r</a></li>
<li><a href="https://teuder.github.io/rcpp4everyone_en/" target="_blank" rel="noopener">https://teuder.github.io/rcpp4everyone_en/</a></li>
<li><a href="https://teuder.github.io/rcpp4everyone_en/" target="_blank" rel="noopener"> http://www.mjdenny.com/Rcpp_Intro.html </a></li>
</ol>
</div><div class="tags"><a href="/tags/R-Code-Optimization/">R, Code Optimization</a></div><div class="post-nav"><a class="next" href="/2019/05/07/welcome/">Welcome To My Blog</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://yiransblog.com/2019/05/08/article1/';
    this.page.identifier = '2019/05/08/article1/';
    this.page.title = 'Fast Large Matrices Multiplication in R Using Rcpp';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//yiransblog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//yiransblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://yiransblog.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yiransblog.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/R/">R</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/R-Code-Optimization/" style="font-size: 15px;">R, Code Optimization</a> <a href="/tags/others/" style="font-size: 15px;">others</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/08/article1/">Fast Large Matrices Multiplication in R Using Rcpp</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/welcome/">Welcome To My Blog</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//yiransblog.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://linkedin.com/in/yiran-wang-129006120/" title="LinkedIn" target="_blank">LinkedIn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Yiran's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zindex="-2" count="50" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>